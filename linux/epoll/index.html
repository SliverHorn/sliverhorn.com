<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>深入理解Linux中网络I/O复用并发模型 | SliverHorn的博客</title><meta property="og:title" content="深入理解Linux中网络I/O复用并发模型 - SliverHorn的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-11-05T17:17:17+08:00"><meta property="article:modified_time" content="2022-11-05T17:17:17+08:00"><meta name=Keywords content="golang,SliverHorn,gin-vue-admin,gf-vue-admin
"><meta name=description content="深入理解Linux中网络I/O复用并发模型"><meta name=author content="SliverHorn"><meta property="og:url" content="https://sliverhorn.com/linux/epoll/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet><link rel=stylesheet href=/css/douban.css><link rel=stylesheet href=/css/other.css></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://sliverhorn.com>SliverHorn的博客</a><p class=description>Golang 开发</p></div><div><nav id=nav-menu class=clearfix><a href=https://sliverhorn.com>首页</a>
<a href=https://sliverhorn.com/linux/ title=linux>linux</a>
<a href=https://sliverhorn.com/tool/ title=工具>工具</a>
<a href=https://sliverhorn.com/about/ title=关于>关于</a>
<a href=https://sliverhorn.com/archives/ title=归档>归档</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><style type=text/css>.post-toc{position:fixed;width:200px;margin-left:-210px;padding:5px 10px;font-family:Athelas,STHeiti,Microsoft Yahei,serif;font-size:12px;border:1px solid rgba(0,0,0,7%);border-radius:5px;background-color:rgba(255,255,255,.98);background-clip:padding-box;-webkit-box-shadow:1px 1px 2px rgba(0,0,0,.125);box-shadow:1px 1px 2px rgba(0,0,0,.125);word-wrap:break-word;white-space:nowrap;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:999;cursor:pointer;max-height:70%;overflow-y:auto;overflow-x:hidden}.post-toc .post-toc-title{width:100%;margin:0 auto;font-size:20px;font-weight:400;text-transform:uppercase;text-align:center}.post-toc .post-toc-content{font-size:15px}.post-toc .post-toc-content>nav>ul{margin:10px 0}.post-toc .post-toc-content ul{padding-left:20px;list-style:square;margin:.5em;line-height:1.8em}.post-toc .post-toc-content ul ul{padding-left:15px;display:none}@media print,screen and (max-width:1057px){.post-toc{display:none}}</style><div class=post-toc style=position:absolute;top:188px><h2 class=post-toc-title>文章目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#本文说明>本文说明</a></li><li><a href=#基本概念>基本概念</a><ul><li><a href=#流>流</a></li><li><a href=#io操作>I/O操作</a></li><li><a href=#阻塞>阻塞</a></li><li><a href=#多路io复用>多路IO复用</a></li></ul></li><li><a href=#解决阻塞死等待的缺点>解决阻塞死等待的缺点</a></li><li><a href=#epoll-的api>Epoll 的API</a><ul><li><a href=#创建epoll>创建EPOLL</a></li><li><a href=#控制epoll>控制EPOLL</a></li><li><a href=#等待epoll>等待EPOLL</a></li><li><a href=#使用epoll编程主流程骨架>使⽤用epoll编程主流程⻣骨架</a></li></ul></li><li><a href=#触发模式>触发模式</a><ul><li><a href=#水平触发>水平触发</a></li><li><a href=#边缘触发>边缘触发</a></li></ul></li><li><a href=#单线程accepto复用>单线程Accept(⽆O复用)</a><ul><li><a href=#模型分析>模型分析</a></li><li><a href=#优点>优点</a></li><li><a href=#缺点>缺点</a></li></ul></li><li><a href=#单线程accept多线程读写业务io复用>单线程Accept+多线程读写业务(⽆IO复用)</a><ul><li><a href=#模型分析-1>模型分析</a></li><li><a href=#优点-1>优点</a></li><li><a href=#缺点-1>缺点</a></li></ul></li><li><a href=#单线程多路io复>单线程多路IO复⽤</a><ul><li><a href=#模型分析-2>模型分析</a></li><li><a href=#优点-2>优点</a></li><li><a href=#缺点-2>缺点</a></li></ul></li><li><a href=#单线程多路io复用多线程读写业务业务工作池>单线程多路IO复用+多线程读写业务(业务工作池)</a><ul><li><a href=#模型分析-3>模型分析</a></li><li><a href=#优点-3>优点</a></li><li><a href=#缺点-3>缺点</a></li></ul></li><li><a href=#单线程io复用多线程io复链接线程池>单线程IO复用+多线程IO复⽤(链接线程池)</a><ul><li><a href=#模型分析-4>模型分析</a></li><li><a href=#优点-4>优点</a></li><li><a href=#缺点-4>缺点</a></li></ul></li><li><a href=#单进程多路io复多进程多路io复用进程池>单进程多路I/O复⽤+多进程多路I/O复用(进程池)</a><ul><li><a href=#模型分析-5>模型分析</a></li><li><a href=#优缺点>优缺点</a></li></ul></li><li><a href=#单线程多路io复用多线程多路io复用多线程>单线程多路I/O复用+多线程多路I/O复用+多线程</a><ul><li><a href=#模型分析-6>模型分析</a></li><li><a href=#优点-5>优点</a></li><li><a href=#缺点-5>缺点</a></li></ul></li></ul></nav></div></div><script type=text/javascript>$(document).ready(function(){if(e=$(".post-toc"),e.length){t=$("#main").offset().left,t<220&&e.css({width:t-10,"margin-left":0-t});var e,t,n=e.offset().top-20,s={start:{position:"absolute",top:n},process:{position:"fixed",top:20}};$(window).scroll(function(){var t=$(window).scrollTop();t<n?e.css(s.start):e.css(s.process)})}$("#TableOfContents").children().length<1&&$(".post-toc").remove()})</script><article class=post><header><h1 class=post-title>深入理解Linux中网络I/O复用并发模型</h1></header><date class="post-meta meta-date">2022年11月5日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><h2 id=本文说明>本文说明</h2><p>本文所有内容来自于 <a href=https://github.com/aceld>AceId</a> 如有侵权，联系作者删除！</p><h2 id=基本概念>基本概念</h2><h3 id=流>流</h3><ul><li>可以进行I/O操作的内核对象</li><li>文件、管道、套接字&mldr;&mldr;</li><li>流的入口：文件描述符(fd)</li></ul><h3 id=io操作>I/O操作</h3><p>所有对流的读写操作，都可以称之为I/O操作</p><h3 id=阻塞>阻塞</h3><ul><li>阻塞等待：不占用CPU宝贵的时间片<ul><li>缺点：不能够很好的处理多个(I/O)请求的问题</li><li>同一个阻塞，同一时刻只能处理一个流的阻塞监听</li></ul></li><li>非阻塞忙轮询 ：占用CPU，系统资源</li></ul><blockquote><p>在处理意见数据的接收场景时，建议优先使用阻塞等待的方式，不浪费性能资源</p></blockquote><h3 id=多路io复用>多路IO复用</h3><ul><li>既能够阻塞等待，不浪费资源</li><li>也能够同一时刻监听多个IO请求的状态</li></ul><h2 id=解决阻塞死等待的缺点>解决阻塞死等待的缺点</h2><ol><li>阻塞等待+多进程/多线程：需要开辟线程浪费资源</li><li>非阻塞+忙轮询：<ol><li>CPU在大量的做判读，while 和 for</li><li>CPU的利用率不高</li></ol></li></ol><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#000;font-weight:700>while</span> <span style=color:#0086b3>true</span> {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>for</span> i in <span style=color:#a61717;background-color:#e3d2d2>流</span>[] {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>if</span> i has <span style=color:#a61717;background-color:#e3d2d2>数据</span> {
</span></span><span style=display:flex><span>			<span style=color:#a61717;background-color:#e3d2d2>读</span> <span style=color:#a61717;background-color:#e3d2d2>或者</span> <span style=color:#a61717;background-color:#e3d2d2>其他处理</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>多路IO复用机制 &ndash; select<ol><li>监听的IO数量有限，默认是1024个</li><li>不会精准的告诉开发者，哪些IO是可读可写的，需要遍历</li></ol></li></ol><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#000;font-weight:700>while</span> <span style=color:#0086b3>true</span> {
</span></span><span style=display:flex><span>	select(<span style=color:#a61717;background-color:#e3d2d2>流</span>[]); <span style=color:#998;font-style:italic>// 阻塞
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#998;font-style:italic>// 有消息抵达
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#000;font-weight:700>for</span> i in <span style=color:#a61717;background-color:#e3d2d2>流</span>[] {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>if</span> i has <span style=color:#a61717;background-color:#e3d2d2>数据</span> {
</span></span><span style=display:flex><span>			<span style=color:#a61717;background-color:#e3d2d2>读</span> <span style=color:#a61717;background-color:#e3d2d2>或者</span> <span style=color:#a61717;background-color:#e3d2d2>其他处理</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>多路IO复用机制 &ndash; epoll<ol><li>与 select，poll 一样，对I/O多路复用的技术</li><li>只关心“活跃”的链接，无需遍历全部描述集合</li><li>能够处理大量的链接请求(系统可以打开的文件数目， 可以通过/proc/sys/fd/file-max查看)</li></ol></li></ol><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#000;font-weight:700>while</span> <span style=color:#0086b3>true</span> {
</span></span><span style=display:flex><span>	<span style=color:#a61717;background-color:#e3d2d2>可处理的流</span>[] <span style=color:#000;font-weight:700>=</span> epoll_wait(epoll_fd) <span style=color:#998;font-style:italic>// 阻塞
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic>// 有消息抵达,全部放在 “可处理的流[]”中
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#000;font-weight:700>for</span> i in <span style=color:#a61717;background-color:#e3d2d2>可处理的流</span>[] {
</span></span><span style=display:flex><span>		<span style=color:#a61717;background-color:#e3d2d2>读</span> <span style=color:#a61717;background-color:#e3d2d2>或者</span> <span style=color:#a61717;background-color:#e3d2d2>其他处理</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=epoll-的api>Epoll 的API</h2><h3 id=创建epoll>创建EPOLL</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#998;font-style:italic>// epoll_create 创建一个EPOLL实例。返回新实例的FD。“Size”参数是一个提示，指定要与新实例关联的文件描述符的数量。
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// EPOLL_CREATE()返回的FD应该用Close()关闭。
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// size 内核监听的数目
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// return 返回一个epoll句柄(即一个文件描述符)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>epoll_create</span> (<span style=color:#458;font-weight:700>int</span> __size);
</span></span></code></pre></td></tr></table></div></div><h3 id=控制epoll>控制EPOLL</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#998;font-style:italic>/* Valid opcodes ( &#34;op&#34; parameter ) to issue to epoll_ctl().  */</span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLL_CTL_ADD 1	</span><span style=color:#998;font-style:italic>/* Add a file descriptor to the interface.  */</span><span style=color:#999;font-weight:700;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLL_CTL_DEL 2	</span><span style=color:#998;font-style:italic>/* Remove a file descriptor from the interface.  */</span><span style=color:#999;font-weight:700;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLL_CTL_MOD 3	</span><span style=color:#998;font-style:italic>/* Change file descriptor epoll_event structure.  */</span><span style=color:#999;font-weight:700;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#998;font-style:italic>/* 
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>	 Manipulate an epoll instance &#34;epfd&#34;. Returns 0 in case of success,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   -1 in case of error ( the &#34;errno&#34; variable will contain the
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   specific error code ) The &#34;op&#34; parameter is one of the EPOLL_CTL_*
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   constants defined above. The &#34;fd&#34; parameter is the target of the
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   operation. The &#34;event&#34; parameter describes which events the caller
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   is interested in and any associated user data.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>extern</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>epoll_ctl</span> (<span style=color:#458;font-weight:700>int</span> __epfd, <span style=color:#458;font-weight:700>int</span> __op, <span style=color:#458;font-weight:700>int</span> __fd, <span style=color:#000;font-weight:700>struct</span> epoll_event <span style=color:#000;font-weight:700>*</span>__event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>enum</span> EPOLL_EVENTS
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    EPOLLIN <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x001</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLIN EPOLLIN
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLPRI <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x002</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLPRI EPOLLPRI
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLOUT <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x004</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLOUT EPOLLOUT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLRDNORM <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x040</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLRDNORM EPOLLRDNORM
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLRDBAND <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x080</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLRDBAND EPOLLRDBAND
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLWRNORM <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x100</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLWRNORM EPOLLWRNORM
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLWRBAND <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x200</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLWRBAND EPOLLWRBAND
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLMSG <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x400</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLMSG EPOLLMSG
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLERR <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x008</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLERR EPOLLERR
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLHUP <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x010</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLHUP EPOLLHUP
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLRDHUP <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0x2000</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLRDHUP EPOLLRDHUP
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLEXCLUSIVE <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1u</span> <span style=color:#000;font-weight:700>&lt;&lt;</span> <span style=color:#099>28</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLEXCLUSIVE EPOLLEXCLUSIVE
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLWAKEUP <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1u</span> <span style=color:#000;font-weight:700>&lt;&lt;</span> <span style=color:#099>29</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLWAKEUP EPOLLWAKEUP
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLONESHOT <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1u</span> <span style=color:#000;font-weight:700>&lt;&lt;</span> <span style=color:#099>30</span>,
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLONESHOT EPOLLONESHOT
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>    EPOLLET <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1u</span> <span style=color:#000;font-weight:700>&lt;&lt;</span> <span style=color:#099>31</span>
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#define EPOLLET EPOLLET
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>struct</span> epoll_event
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>uint32_t</span> events;	<span style=color:#998;font-style:italic>/* Epoll events */</span>
</span></span><span style=display:flex><span>  epoll_data_t data;	<span style=color:#998;font-style:italic>/* User data variable */</span>
</span></span><span style=display:flex><span>} __EPOLL_PACKED;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>typedef</span> <span style=color:#000;font-weight:700>union</span> epoll_data
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>void</span> <span style=color:#000;font-weight:700>*</span>ptr;
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>int</span> fd;
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>uint32_t</span> u32;
</span></span><span style=display:flex><span>  <span style=color:#458;font-weight:700>uint64_t</span> u64;
</span></span><span style=display:flex><span>} epoll_data_t;
</span></span></code></pre></td></tr></table></div></div><h3 id=等待epoll>等待EPOLL</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#998;font-style:italic>/* Same as epoll_wait, but the thread&#39;s signal mask is temporarily
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   and atomically replaced with the one provided as parameter.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   This function is a cancellation point and therefore not marked with
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>   __THROW.  */</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>extern</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>epoll_pwait</span> (<span style=color:#458;font-weight:700>int</span> __epfd, <span style=color:#000;font-weight:700>struct</span> epoll_event <span style=color:#000;font-weight:700>*</span>__events, <span style=color:#458;font-weight:700>int</span> __maxevents, <span style=color:#458;font-weight:700>int</span> __timeout, <span style=color:#000;font-weight:700>const</span> __sigset_t <span style=color:#000;font-weight:700>*</span>__ss);
</span></span></code></pre></td></tr></table></div></div><h3 id=使用epoll编程主流程骨架>使⽤用epoll编程主流程⻣骨架</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#998;font-style:italic>// 创建epoll
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>int</span> epfd <span style=color:#000;font-weight:700>=</span> epoll_create(<span style=color:#099>1000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// 将listen_fd 添加进 epoll 中
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>epoll_ctl(epfd, EPOLL_CTL_ADD, listen_fd, <span style=color:#000;font-weight:700>&amp;</span>listen_event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>while</span> (<span style=color:#099>1</span>) {
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>// 阻塞等待epoll中的fd触发
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>  <span style=color:#458;font-weight:700>int</span> artive_cnt <span style=color:#000;font-weight:700>=</span> epoll_wait(epfd, events, <span style=color:#099>1000</span>, <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>for</span> (i <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>; i <span style=color:#000;font-weight:700>&lt;</span> active_cnt; i<span style=color:#000;font-weight:700>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (event[i].data.fd <span style=color:#000;font-weight:700>==</span> listen_fd) {
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>// accept. 并且将accept的fd加进epoll中。
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    } <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>if</span> (event[i].events <span style=color:#000;font-weight:700>&amp;</span> EPOLLIN) {
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>// 对此fd 进行读操作
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    } <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>if</span> (event[i].events <span style=color:#000;font-weight:700>&amp;</span> EPOLLOUT) {
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>// 对此fd 进行写操作
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=触发模式>触发模式</h2><blockquote><p>默认是水平触发模式，如果要边缘触发模式，要在给事件进行绑定的时候通过 <code>EPOOLET</code> 来设置</p></blockquote><h3 id=水平触发>水平触发</h3><p>如果用户在监听 <code>epoll</code> 事件，当内核有事件的时候，会拷贝给用户态事件，但是如果用户只处理了一次，那么剩下没有处理的会在下一次 <code>epoll_wait</code> 再次返回该事件。</p><h3 id=边缘触发>边缘触发</h3><p>相比跟水平触发相反，当内核有事件达到，只会通知用户一次，至于用户处理还是不处理，以后将不会再通知，这样减少了拷贝过程，增加了性能，但是相对来说，如果用户马虎忘记处理，将会产生事件丢的情况</p><h2 id=单线程accepto复用>单线程Accept(⽆O复用)</h2><p><a data-fancybox=gallery href=/linux/epoll_1.png><img class=mx-auto alt=epoll_1 src=/linux/epoll_1.png></a></p><h3 id=模型分析>模型分析</h3><ol><li>主线程 main thread 执行阻塞Accept， 每次客户端Connect链接过来， main thread中accept响应并建立连接。</li><li>创建链接成功， 得到Connfd1套接字后，依然在main thread串行处理套接字读写，并处理业务。</li><li>在2处理业务中，如果有新客户端Connect过来，Server无响应，直到当前套接字全部业务处理完毕。</li><li>当前客户端处理完后，完毕链接，处理下一个客户端请求。</li></ol><h3 id=优点>优点</h3><p>socket编程流程清晰简单那，适合学习使用，了解socket基本编程流程。</p><h3 id=缺点>缺点</h3><ol><li><p>该模型并非并发模型，是串行的服务器，同一时刻，监听并响应最大的网络请求量为1。即并发量为1。</p></li><li><p>仅适合学习基本socket编程，不适合任何服务器Server构建。</p></li></ol><h2 id=单线程accept多线程读写业务io复用>单线程Accept+多线程读写业务(⽆IO复用)</h2><p><a data-fancybox=gallery href=/linux/epoll_2.png><img class=mx-auto alt=epoll_2 src=/linux/epoll_2.png></a></p><h3 id=模型分析-1>模型分析</h3><ol><li>主线程main thread 执行阻塞Accept， 每次客户端Connect链接过来，main thread 中accept响应并建立连接</li><li>创建链接成功，得到Connfd1套接字后，创建一个新线程thread1用来处理客户端的读写业务。main thread依旧回到Accept阻塞等待新客户端。</li><li>thread1通过套接字Connfd1与客户端进行通信读写。</li><li>server在2处理业务中，如果有新客户端Connect过来，main thread中Accept依然响应并建立连接， 重复2过程</li></ol><h3 id=优点-1>优点</h3><ol><li>基于 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8Baccepto%E5%A4%8D%E7%94%A8>单线程Accept(⽆O复用)</a> , 支持了并发的特性</li><li>使用比较灵活，一个客户端对应一个线程单独处理，server处理业务的内聚性比较高，客户端无论如何写、服务端均会有一个线程做资源响应</li></ol><h3 id=缺点-1>缺点</h3><ol><li>随着客户端的数量增多，需要开辟的线程的数量也增加，客户端和server线程的数量1:1正比关系。因此对于高并发场景，现成数量受到硬件的瓶颈。线程过多也会增加CPU的切换成本，降低CPU的利用率。</li><li>对于长链接，客户端一旦无业务读写，只要不关闭，server就应该对保持这个连接的状态(心跳检测，健康检查机制)，占用连接资源和线程的开销</li><li>仅适合客户端数量不大，并且是可控的场景来使用</li><li>适合学习基本的socket编程，不适合做并发服务器</li></ol><h2 id=单线程多路io复>单线程多路IO复⽤</h2><p><a data-fancybox=gallery href=/linux/epoll_3.png><img class=mx-auto alt=epoll_3 src=/linux/epoll_3.png></a></p><h3 id=模型分析-2>模型分析</h3><ol><li>主线程main thread创建listenFd之后，采用多路I/O复用机制(select、epoll)进行IO状态阻塞监控。有Client1客户端Connect请求，I/O复用机制检车ListenFd触发读时间，则进行Accept建立连接，并将新生成的connFd1加入到监听I/O集合中。</li><li>Client1再次进行正常读写业务请求，main thread的多路I/O复用机制阻塞返回，会触该套接字的读/写事件等。</li><li>对于Client1的读写业务，Server依旧在main thread执行流程中继续执行，此时如果有新的客户端COnnect链接请求过来，Server将没有即时响应。</li><li>等到Server处理完一个链接的Read+Write操作，继续回到多路I/O复用机制阻塞，其他链接过来重复2、3流程</li></ol><h3 id=优点-2>优点</h3><ol><li>单线程解决了可以监听多个客户端读写状态，不需要1:1客户端的线程数量关系</li><li>多路I/O复用，阻塞，非忙轮询状态，不浪费CPU资源，对CPU利用率较高</li></ol><h3 id=缺点-2>缺点</h3><ol><li><p>虽然可以监听多个客户端读写状态，但是同一时间，只能够处理一个客户端的读写操作，实际上读写业务并发为1</p></li><li><p>当多个客户端访问server， 业务是串行执行，大量请求的会有排队延迟的现象。比如Client3占据main thread流程时，Client1和Client2流程会卡在IO复用等待下次监听触发事件。</p></li></ol><h2 id=单线程多路io复用多线程读写业务业务工作池>单线程多路IO复用+多线程读写业务(业务工作池)</h2><p><a data-fancybox=gallery href=/linux/epoll_4.png><img class=mx-auto alt=epoll_4 src=/linux/epoll_4.png></a></p><h3 id=模型分析-3>模型分析</h3><ol><li>主线程main thread创建listenFd之后，采用多路I/O复用机制(select、epoll)进行IO状态阻塞监控，有Client客户端Connect请求，I/O复用机制检测到ListenFd触发时间，则进行Accept建立连接，并将新生成的connFd加入到监听I/O集合中。</li><li>当connFd1有可读消息，触发读事件，并且进行读写消息</li><li>main thread按照固定的协议读取消息，并且交给worker poll工作线程池，工作线程池在server启动之前就已经开启固定数量的thread，里面的写成只处理消息业务，不进行套接字读写操作。</li><li>工作池处理完业务，触发connFd1写事件，将回执客户端的消息通过main thread写给对方。</li></ol><h3 id=优点-3>优点</h3><ol><li>对于 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%A4%9A%E8%B7%AFio%E5%A4%8D>单线程多路io复⽤</a> 将业务的处理部分，通过工作池分离出来。能够减少客户端访问Server导致业务串行会有大量请求排队的延迟时间</li><li>实际上读写的业务并发为1，但是业务流程的并发为word pool线程数量，加快了业务处理的并行效率。</li></ol><h3 id=缺点-3>缺点</h3><ol><li>读写依旧是main thread单独处理，最高的读写并行通道依然为1</li><li>虽然多个worker线程处理业务，但是最后返回给客户端依旧也需要排队。因为出口还是main thread的read+write 1个通道</li></ol><h2 id=单线程io复用多线程io复链接线程池>单线程IO复用+多线程IO复⽤(链接线程池)</h2><p><a data-fancybox=gallery href=/linux/epoll_5.png><img class=mx-auto alt=epoll_5 src=/linux/epoll_5.png></a></p><h3 id=模型分析-4>模型分析</h3><ol><li>Server在启动监听之间，开辟固定数量(N)的线程，用Thread Pool线程池管理</li><li>主线程main thread 创建listenFd之后，采用多路I/O复用机制(select，epoll)进行IO状态阻塞监控。有Client1客户端Connect请求，I/O复用机制检测到ListenFd触发读事件，则进行Accept建立连接，并将新生成的connFd1分发给Thread Pool中的某个线程进行监听。</li><li>Thread Pool中的每个thread都启动多路I/O复用机制(select、epoll)，用来监听main thread 建立成功并且分发下来的socket套接字</li><li>如图，thread1监听ConnFd1、ConnFd2，thread2监听ConnFd3，thread3监听ConnFd4， 当对应的ConnFd有读写事件，对应的线程处理该套接字的读写及业务。</li></ol><h3 id=优点-4>优点</h3><ol><li><p>将之前 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%A4%9A%E8%B7%AFio%E5%A4%8D>单线程多路io复⽤</a> ，分散到多线程类完成，这样就增加了同一时刻读写的并行通道，并行通道的数量N，N是线程池线程的数量</p></li><li><p>Server同事监听ConnFd套接字的数量，几乎是成倍增加，之前的全部的监控数量取决于main thread的多路IO复用机制的最大限制(select 1024, epoll默认与内存大小有关，约3 ~ 6w不等)，所以理论单点Server最高响应并发数量N*(3 ~ 6w)</p><blockquote><p>N是线程池的线程数量，建议线程的数量和CPU核心的数量比例是1:1</p></blockquote></li><li><p>如果良好的线程池数量和CPU核心数适配，那么可以尝试CPU核心与Thread进行绑定，从而减低CPU的切换频率，提升每个Thread处理合理业务的效率，降低CPU的切换成本</p></li></ol><h3 id=缺点-4>缺点</h3><ol><li>虽然监听的并发数量提升，但是最高的读写并行通道依然为N，并且多个身处与同一个Thread的客户端，会出现读写延迟现象。实际上每个Thread模型的特征与 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%A4%9A%E8%B7%AFio%E5%A4%8D>单线程多路io复⽤</a> 单线程多路IO复用机制是一致的。</li></ol><h2 id=单进程多路io复多进程多路io复用进程池>单进程多路I/O复⽤+多进程多路I/O复用(进程池)</h2><p><a data-fancybox=gallery href=/linux/epoll_6.png><img class=mx-auto alt=epoll_6 src=/linux/epoll_6.png></a></p><h3 id=模型分析-5>模型分析</h3><ol><li>与 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8Bio%E5%A4%8D%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8Bio%E5%A4%8D%E9%93%BE%E6%8E%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0>单线程IO复用+多线程IO复⽤(链接线程池)</a> 无大差异</li><li>不同点：<ol><li>进程和线程的内存不同导致，main process(主进程) 不再Accept操作，而是将Accept过程分散给各个子进程(process)中。</li><li>进程的特性，资源独立，所以main process如果Accept成功的fd，其他进程无法共享资源，所以要各子进程自行Accept创建链接</li><li>main process只是监听ListenFd状态，一旦触发读事件(有新连接请求)，通过一些IPC(进程间通信：如信号、共享内存、管道)等，让各自子进程Process竞争Accept完成链接建立，并各自监听</li></ol></li></ol><h3 id=优缺点>优缺点</h3><ol><li><p>与 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8Bio%E5%A4%8D%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8Bio%E5%A4%8D%E9%93%BE%E6%8E%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0>单线程IO复用+多线程IO复⽤(链接线程池)</a> 无大差异</p></li><li><p>不同点：</p><ol><li>多进程内存资源占用稍微大一些</li><li>多进程模型安全稳定型比较强，这也是因为各自进程互不干扰的特点导致</li></ol></li></ol><h2 id=单线程多路io复用多线程多路io复用多线程>单线程多路I/O复用+多线程多路I/O复用+多线程</h2><p><a data-fancybox=gallery href=/linux/epoll_7.png><img class=mx-auto alt=epoll_7 src=/linux/epoll_7.png></a></p><h3 id=模型分析-6>模型分析</h3><ol><li>Server在启动监听之前，开辟固定数量(N)的线程，用Thread Pool线程池管理</li><li>主线程main thread创建ListenFd之后，采用多路I/O复用机制(如：select、epoll)进行IO状态阻塞监控。有Client1客户端Connect请求，I/O复用机制检测到ListenFd触发读事件，则进行Accept建立连接，并将新生成的ConnFd1分发给Thread Pool中的某个线程进行监听。</li><li>Thread Pool中的每个Thread都启动多路I/O复用机制(select、epoll),用来监听main thread建立成功并分发下来的socket套接字。一旦其中某个被监听的客户端套接字触发I/O读写业务</li><li>当某个读写线程完成当前读写业务，如果当前套接字没有被关闭，那么将当前客户端套接字如ConnFd3重新加回线程自我销毁</li></ol><h3 id=优点-5>优点</h3><ol><li>在 <a href=#%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%A4%9A%E8%B7%AFio%E5%A4%8D%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%AF%BB%E5%86%99%E4%B8%9A%E5%8A%A1%E4%B8%9A%E5%8A%A1%E5%B7%A5%E4%BD%9C%E6%B1%A0>单线程IO复用+多线程IO复⽤(链接线程池)</a> 基础上，除了能够保证同事相应最高的并发数，又能够解决读写并行通道的局限问题</li><li>同一时刻的读写并行通道，达到了最大化极限，一个客户端可以对应一个单独的执行流程处理读写业务，读写并行通道与客户端的数量1:1关系</li></ol><h3 id=缺点-5>缺点</h3><ol><li>该模型过于理想化，因为要求CPU核心数数量足够大。</li><li>如果硬件CPU数量可数，那么该模型就造成大量CPU切换的成本浪费。因为为了保证读写并行通道和客户端是1:1的关系，就要保证server开辟的thread的数量与客户端一致。</li></ol></div><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/post/aria2c/>Aria2c</a></li><li><a href=/post/2021/>2021 年度总结</a></li><li><a href=/post/linux/oh-my-zsh-install/>oh-my-zsh Mac 安装教程</a></li><li><a href=/tool/mac/>Mac Tool</a></li><li><a href=/about/>关于</a></li></ul></div><div class="post-meta meta-tags">没有标签</div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo="your github repo" issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2022 <a href=https://sliverhorn.com>SliverHorn的博客 By SliverHorn</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>粤ICP备19128176号</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script src=/js/douban.js></script></div><div id=secondary><section class=widget><form id=search action=https://sliverhorn.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://sliverhorn.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://sliverhorn.com/post/aria2c/ title=Aria2c>Aria2c</a></li><li><a href=https://sliverhorn.com/post/2021/ title="2021 年度总结">2021 年度总结</a></li><li><a href=https://sliverhorn.com/post/linux/oh-my-zsh-install/ title="oh-my-zsh Mac 安装教程">oh-my-zsh Mac 安装教程</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://sliverhorn.com/categories/Linux/>Linux (1)</a></li><li><a href=https://sliverhorn.com/categories/Mac/>Mac (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=https://sliverhorn.com/tags/oh-my-zsh/>oh-my-zsh</a>
<a href=https://sliverhorn.com/tags/tool/>tool</a></div></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.squeeze-juice.cn/ title=榨汁>榨汁</a></li><li><a target=_blank href=https://blog.leonardwang.cn/ title="牛逼哄哄 `王哥` 博客">牛逼哄哄 `王哥` 博客</a></li><li><a target=_blank href=https://www.cnblogs.com/binHome/ title=songzhibin97的博客>songzhibin97的博客</a></li><li><a target=_blank href=https://leixf.cn/ title="跃动指尖 – 悦动生活">跃动指尖 – 悦动生活</a></li><li><a target=_blank href=https://www.treesystem.cn title=术习电报>术习电报</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://sliverhorn.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>